---
title: 对多人扫雷课设核心算法的分析
date: 2022-06-06 21:20:39
categories:
  - [课程设计, 网页版多人扫雷]
tags:
	- 算法
	- 扫雷
---

#  序言

一开始打算自己写的，但想起来无敌的xxy早在报告中介绍过这一部分了，便直接拿过来用乐。

# 项目连接

[Wldcmzy/Multiplayer-MineSweeper: 网页版多人扫雷 web前端+python flask后端+websocket通讯 JS/CSS代码内置于HTML (github.com)](https://github.com/Wldcmzy/Multiplayer-MineSweeper)

# 一些定义

**复制时序号错乱，不以序号为准。**

（7）开荒：用户点击一个未知状态的方格后，根据开荒规则打开一片区域。开荒有2个阶段：点击开荒、遍历开荒，分别对应两种开荒规则，规则请参照定义第8、9条。

（8）点击开荒规则：点击开荒阶段的规则。先打开用户点击位置的方格。如果用户点击位置方格打开状态不是雷，则打开八方位方格中打开状态为0的方格。

（9）遍历开荒规则：遍历开荒阶段的规则。对打开的八方位方格中的方格继续进行开荒。如果方格打开状态是0，打开八方位的全部方格，然后重复执行该遍历开荒规则；如果方格打开状态是1、2、3、4、5、6、7、8，停止当前方格的遍历开荒。



（1） 时间戳：用户点击请求到达服务器的相对时间顺序。

（2） 用户颜色：每个用户在每一局游戏中会获得一个颜色，雷区地图上用用户颜色标识用户开荒区域。同一用户在同一局游戏中始终具有相同的用户颜色，用户的退出不能更改本局的用户颜色。游戏重开后，用户颜色重置。

（3） 染色：将用户开荒区域的方格由初始颜色变更为用户颜色。

（4） 染色修正：用户颜色的修正。在多人进行游戏时，因为数据传输的延迟，所以前端收到的广播顺序不一定是操作到达服务器的顺序。所以有可能出现用户A的点击请求先到达服务端，由于服务端还未广播A的点击或者前端收到了广播还没有进行开荒，用户B可能点击了和用户A开荒的区域有交集的位置，用户B的点击请求也会到达服务端。服务器会先广播A的点击，后广播B的点击。用户B的广播可能先到前端，这样前端就会将区域判定为用户B的区域导致错误。所以增加染色修正的概念。前端会根据染色修正规则将开荒区域调整为正确的颜色。染色修正规则请参照定义第18条。

（5） 染色修正规则：以时间戳为依据，方格的颜色为时间戳最小的用户对应的用户颜色。

# 算法分析

## 1、雷区生成算法

雷区生成算法的参数有：子区域行列数、子区域雷数、雷区地图行数、雷区地图列数、模数、雷区种子、斐波那契数列值。

设置子区域的目的是为了防止部分区域雷的密度不够，一次开荒出大片区域，递归栈空间不够用。同时也是为了更好的用户体验。将雷区地图按照子区域行列数进行划分，依次进行每个子区域的地图生成。划分边界的不够完整的子区域的雷区，按照完整子区域的雷的密度计算得出该区域的雷数。

斐波那契数列值用于辅助进行子区域布雷，每局雷区地图生成初始为数列第1项。

子区域地图生成：

（1）子区域按顺序从上到下、从左到右对每个方格依次进行编号，编号从0开始，每次递增1。最终编号小于子区域雷数的方格为有雷的方格。

（2）定义辅助变量delta，初始化令其等于雷区种子

（3）子区域按顺序从上到下、从左到右枚举，对枚举到的每个格子进行编号的交换。交换规则：先递推一次斐波那契数列，辅助变量delta和斐波那契数列值相乘，并对模数取模。若取模结果大于子区域雷数，持续和斐波那契数列值相乘，直至取模结果小于子区域雷数。delta%行数为交换位置的子区域行号。再将delta除以子区域行数，delta%列数为交换位置的子区域列号。交换枚举位置和交换位置的两个方格的数字。

（4）将子区域地图信息转移到雷区地图上。

## 2、开荒算法

根据定义中的点击开荒规则和遍历开荒规则进行dfs遍历雷区地图。具体有四种情况：

（1）前端同步本局历史数据时：由于接收到的历史数据是按按照时间戳排好序的，所以直接按照规则进行dfs遍历，同时在遍历过程中进行染色。

（2）前端收到广播时：由于收到的广播顺序不一定是按时间戳排好序的，所以按照规则进行dfs遍历，同时在遍历过程中进行染色，如果在dfs遍历中发生要对已染色的区域再次染色，则参考染色修正规则。

（3）前端进行用户本地开荒时：只按照规则进行dfs遍历，不染色。

（4）后端遍历：因为时间戳表示到达后端的时间，所以后端直接判断初始位置是否被遍历过，若没有，进行遍历即可。

## 3、用户颜色分配算法

  颜色库中规定多种色调的颜色，每种色调有若干亮度不同的颜色。

（1）确定色调：随机一个颜色范围不大于色调的随机数，若该色调使用次数为色调最少使用次数，则确定为该色调，否则向后循环遍历色调，直到找到使用次数为色调最少使用次数的色调。

（2）确定颜色：随机一个不大于该色调颜色数的随机数，若该颜色使用次数为色调内颜色最少使用次数，则确定为该颜色，否则向后循环遍历色调内的颜色，直到找到使用次数为色调内颜色最少使用次数的色调。

## 4、染色修正规则

在染色的时候，永远遵循染时间戳更小的用户颜色。即在发生要对已染色的区域再次染色时：

（1）如果原方格的时间戳更小，则颜色不更改。

（2）如果新的时间戳更小，则更改方格的颜色和时间戳。