---

title: 【学习记录】异步爬虫
date: 2022-08-22 21:58:59
categories:
  - [教练我想学挂边躲牛, 爬虫]
tags:
  - 爬虫
---



## 简易http请求例子

#### 一些前面的东西

```python
import aiohttp
import asyncio
headers = {
    'User-Agent' : 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.102 Safari/537.36 Edg/104.0.1293.63'
}

```

#### 简易get 请求 例子

猜测其他请求可以根据request库类比

携程 text(encoding默认None, 内部自动处理) 返回 aiohttp.ClientResponse类型， 文档可查

```python
async with aiohttp.ClientSession() as session:
    async with session.request(
        'GET',
        'https://wldcmzy.github.io/',
        headers = headers
    ) as res:
        print(await res.text(encoding='utf-8'))
```

等效1

```python
async with aiohttp.ClientSession() as session:
    async with session.get(
        'https://wldcmzy.github.io/',
        headers = headers
    ) as res:
        print(await res.text(encoding='utf-8'))
```

等效2

```python
session = aiohttp.ClientSession()
res = await session.request(
    'GET',
    'https://wldcmzy.github.io/',
    headers = headers
)
print(await res.text(encoding='utf-8'))
session.close()
```

aiohttp.ClientSession构造函数可传一些参数

```python
async with aiohttp.ClientSession(headers = headers) as session:
    async with session.get(
        'https://wldcmzy.github.io/',
        headers = headers
    ) as res:
        print(await res.text(encoding='utf-8'))
```



## 异步爬虫简易实现

```python
import aiohttp
import asyncio
import time
urls = [
    'https://wldcmzy.github.io/',
    'https://docs.aiohttp.org/en/stable/index.html',
    'https://github.com/Nearrin/HollowKnight.PureZote',
    'https://www.baidu.com/',
]
async def getHTML(url):
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as res:
            print(time.time(), (await res.text())[ : 100], sep = '\n', end = '\n<<<<<<<<<<<<<\n')

loop = asyncio.get_event_loop()
tasks = [asyncio.ensure_future(getHTML(each)) for each in urls]
tasks = asyncio.gather(*tasks)
loop.run_until_complete(tasks)


```

